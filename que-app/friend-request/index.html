<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Open in App – Que</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- Smart App Banner（初期値は friendId 未挿入。直後の <script> で動的に差し替え） -->
  <meta id="smart-app-banner" name="apple-itunes-app" content="app-id=6752609590">

  <!-- 基本OG（任意） -->
  <meta property="og:title" content="Open in App – Que">
  <meta property="og:description" content="Open the invite in the Que app.">
  <meta property="og:type" content="website">
  <meta property="og:url" content="https://sadasada1729.github.io/que-app/friend">

  <style>
    :root { color-scheme: light dark; }
    body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, "Hiragino Kaku Gothic ProN", "Yu Gothic", "Noto Sans JP", "Apple Color Emoji", "Segoe UI Emoji", sans-serif; margin: 0; padding: 24px; line-height: 1.6; }
    .container { max-width: 680px; margin: 0 auto; }
    h1 { margin: 0 0 12px; font-size: 1.6rem; }
    p { margin: 0 0 12px; }
    .btn { display: inline-block; padding: 12px 16px; border-radius: 10px; text-decoration: none; border: 1px solid currentColor; }
    .muted { opacity: .72; font-size: .95rem; }
    code { padding: .2em .35em; border-radius: 6px; background: rgba(127,127,127,.12); }
  </style>

  <script>
    // --- tiny i18n ---
    const M = {
      en: {
        title: "Open in App",
        lead: "If you have the app installed, tap the banner at the top to open this invite in Que.",
        fallback: "If you don't have the app, you can get it from the App Store:",
        openAppStore: "Open in App Store",
        debug: "Invite ID",
        note: "If the banner doesn't appear, use the button above."
      },
      ja: {
        title: "アプリで開く",
        lead: "アプリをインストール済みの場合は、画面上部のバナーからQueでこの招待を開けます。",
        fallback: "未インストールの方は App Store から入手できます：",
        openAppStore: "App Storeで開く",
        debug: "招待ID",
        note: "バナーが表示されない場合は、上のボタンをご利用ください。"
      }
    };

    // 言語決定（?lang=en/ja 優先 → ブラウザ言語）
    function decideLang() {
      const qs = new URLSearchParams(location.search);
      const ql = qs.get('lang');
      if (ql && /^(en|ja)$/.test(ql)) return ql;
      const nav = (navigator.language || 'en').toLowerCase();
      return nav.startsWith('ja') ? 'ja' : 'en';
    }

    // 安全なクエリ取得
    function getFriendId() {
      const qs = new URLSearchParams(location.search);
      // 簡易サニタイズ（表示用途のみ。サーバで使う場合は必ず厳格にサニタイズ/検証してください）
      return (qs.get('friendId') || '').replace(/[^a-zA-Z0-9._-]/g, '').slice(0, 128);
    }

    // Smart App Banner の app-argument を現在URLに差し替え（friendIdをアプリへ渡す）
    function setSmartAppBanner(appId) {
      const meta = document.getElementById('smart-app-banner');
      if (!meta) return;
      // 現在の完全URL（lang は渡してもOK / 不要なら削除）
      const appArgument = location.href;
      meta.setAttribute('content', `app-id=${appId}, app-argument=${appArgument}`);
    }

    // App Store へのフォールバック遷移（任意：数百ms後に自動遷移したい場合）
    function setupAutoFallback(appId) {
      // ユーザー体験を損ねないよう、強制自動遷移は避けるのが無難。必要ならコメントアウト解除。
      setTimeout(() => { location.href = `https://apps.apple.com/app/id${appId}`; }, 1200);
    }

    // DOM 塗り込み
    document.addEventListener('DOMContentLoaded', () => {
      const APP_ID = '6752609590';
      const DOMAIN = 'sadasada1729.github.io';

      const lang = decideLang();
      document.documentElement.lang = lang;

      const t = M[lang];
      const fid = getFriendId();

      setSmartAppBanner(APP_ID);
      setupAutoFallback(APP_ID);

      // 文言描画
      document.getElementById('h1').textContent = t.title;
      document.getElementById('lead').textContent = t.lead;
      document.getElementById('fallback-label').textContent = t.fallback;
      document.getElementById('btn-store').textContent = t.openAppStore;
      document.getElementById('note').textContent = t.note;

      // デバッグ表示（任意 / 本番では削除可）
      if (fid) {
        document.getElementById('debug').innerHTML =
          `${t.debug}: <code>${fid}</code>`;
      }

      // App Store ボタン
      const storeUrl = `https://apps.apple.com/app/id${APP_ID}`;
      const btn = document.getElementById('btn-store');
      btn.href = storeUrl;
    });
  </script>
</head>
<body>
  <div class="container">
    <h1 id="h1">Open in App</h1>
    <p id="lead" class="muted">If you have the app installed, tap the banner above.</p>

    <p id="fallback-label">If you don't have the app, you can get it from the App Store:</p>
    <p><a id="btn-store" class="btn" href="https://apps.apple.com/app/id6752609590">Open in App Store</a></p>

    <p id="note" class="muted">If the banner doesn't appear, use the button above.</p>
  </div>
</body>
</html>
